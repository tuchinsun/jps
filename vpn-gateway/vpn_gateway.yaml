type: update
version: 1.4
name: VPN-Gateway
logo: https://github.com/tuchinsun/jps/raw/master/vpn-gateway/img/gateway_icon.png
homepage: https://jelastic.com/
baseUrl: https://github.com/tuchinsun/jps/raw/master/vpn-gateway/
description: |
    VPN-Gateway
skipNodeEmails: true

settings:
  fields:
    - type: radio-fieldset
      name: vpntype
      default: 1
      caption: VPN Technology
      values:
        1: OpenVPN
        2: OpenConnect
        3: AnyConnect
      editable: true
      showIf:
        1:
          - hideLabel: false
            type: text
            name: openvpn_config
            caption: OpenVPN Config
            editable: true
        2:
          - hideLabel: false
            type: string
            name: vpn_server_name
            caption: VPN Server Name / IP

          - hideLabel: false
            defaultMargins:
              top: 0
              bottom: 0
              right: 35
              left: 0
            caption: VPN Login / Password
            type: compositefield
            name: vpn_creds
            items:
                - type: string
                  name: openconnect_user
                - type: string
                  inputType: password
                  name: openconnect_pass
        3:
          - hideLabel: false
            type: string
            name: vpn_server_name
            caption: VPN Server Name / IP

          - hideLabel: false
            defaultMargins:
              top: 0
              bottom: 0
              right: 35
              left: 0
            caption: GROUP Login / Pass
            type: compositefield
            name: vpn_creds
            items:
                - type: string
                  name: anyconnect_group_name
                - type: string
                  inputType: password
                  name: anyconnect_group_pass

          - hideLabel: false
            defaultMargins:
              top: 0
              bottom: 0
              right: 35
              left: 0
            caption: USER Login / Pass
            type: compositefield
            name: vpn_creds
            items:
                - type: string
                  name: anyconnect_user_name
                - type: string
                  inputType: password
                  name: anyconnect_user_pass

    - type: string
      caption: External IP
      name: extip
      editable: true

    - type: text
      caption: Nodes IP:PORT
      name: hn_ips
      editable: true

    - hideLabel: false
      defaultMargins:
        top: 0
        bottom: 0
        right: 35
        left: 0
      caption: Resolvers IP INT
      type: compositefield
      name: resolver_ips
      items:
          - type: string
            name: resolver1
          - type: string
            name: resolver2


nodes:
- count: 1
  fixedCloudlets: 4
  nodeType: centos7
  nodeGroup: vds
  port: 22
  extip: false

onInstall:
  - installCommon
  - configureFirewall

actions:
  installCommon:
    - cmd [centos7]: |-
        yum install epel-release -y >/dev/null 2>&1
        yum install net-tools pwgen ipset-service -y >/dev/null 2>&1
    # OpenVPN
    - if (${settings.vpntype} === 1):
        cmd [centos7]: |-
          yum install openvpn -y
          systemctl enable rc-local
          wget -O "/etc/systemd/system/vpn@.service" "${baseUrl}/config/systemd/openvpn/openvpn-client%40.service"
          mkdir -p /etc/systemd/system/vpn@.service.d
          echo -e "[Service]\nLimitNPROC=infinity" > /etc/systemd/system/vpn@.service.d/override.conf
          systemctl daemon-reload
          systemctl enable vpn@client

        writeFile:
          - nodeType: centos7
            path: /etc/openvpn/client/client.ovpn
            body: ${settings.openvpn_config}

    # OpenConnect
    - if (${settings.vpntype} === 2):
        cmd [centos7]: |-
          yum install openconnect -y
          wget -O "/etc/systemd/system/vpn@.service" "${baseUrl}/config/systemd/openconnect/openconnect%40.service"


    # AnyConnect
    - if (${settings.vpntype} === 3):
        cmd [centos7]: |-
          yum install vpnc -y
          echo -e "IPSec gateway ${settings.vpn_server_name}\nIPSec ID ${settings.anyconnect_group_name}\nIPSec secret ${settings.anyconnect_group_pass}" > /etc/vpnc/client.conf
          echo -e "Xauth username ${settings.anyconnect_user_name}\nXauth password ${settings.anyconnect_user_pass}" >> /etc/vpnc/client.conf
          wget -O "/etc/systemd/system/vpn@.service" "${baseUrl}/config/systemd/vpnc/vpnc%40.service"

  configureFirewall:
    - cmd [centos7]: |-
        systemctl enable ipset
        echo ${nodes.centos7.intIP}
        echo ${settings.extip}
    - cmd [centos7]: wget -qO /tmp/ipset.rules ${baseUrl}/config/firewall/ipset.rules
    - cmd [centos7]: ipset flush; ipset destroy; ipset restore < /tmp/ipset.rules; service ipset save
    - cmd [centos7]: wget -qO /tmp/iptables.rules ${baseUrl}/config/firewall/iptables.rules
    - cmd [centos7]: sed "s/CT_PRIVATE_IP/${nodes.centos7.intIP}/g" -i /tmp/iptables.rules
    - cmd [centos7]: sed "s/CT_PUBLIC_IP/${settings.extip}/g" -i /tmp/iptables.rules
    - cmd [centos7]: iptables-restore /tmp/iptables.rules
    - cmd [centos7]: port=30000; for ipsport in $(echo -e "${settings.hn_ips}"); do $(iptables -t nat -A MAYBE_DNAT -p tcp -m tcp --dport $port -j DNAT --to-destination ${ipsport}); port=$((port+1)); done;
    - cmd [centos7]: echo "${settings.resolver1}
    - cmd [centos7]: echo "${settings.resolver2}
    - cmd [centos7]: sed "s/RESOLVER1_PRIVATE_IP/${settings.resolver1}/g" -i /tmp/iptables.rules
    - cmd [centos7]: sed "s/RESOLVER2_PRIVATE_IP/${settings.resolver2}/g" -i /tmp/iptables.rules

    

success:
   text: |
      ### Installation VPN-Gateway finished
      * **URL** http://${env.domain}
      * **Login:** admin

